<!-------------------------------------------
    POST EDIT PAGE
-------------------------------------------
    Renders all comments for a post
    Shows moderation buttons (approve/delete) only to authenticated users
    Reply form is shown for authenticated users on approved comments
-------------------------------------------
-->

<div class="comments-section-custom" style="background: #f8f3fa !important; border-radius: 18px; padding: 24px;">

    <!-- Comments header -->
    <h2 class="comments-header"
        style="color: #a55c8f; font-family: 'Lobster', cursive; font-weight: bold; margin-bottom: 24px;">Comments:</h2>
    {% if not user.is_authenticated %}

    <!-- Add comment button for guests -->
    <a href="{% url 'add_comment_to_post' pk=post.pk %}" class="add-comment-btn">Add comment</a>
    {% endif %}
    {% for comment in post.comments.all %}
    {% if not comment.parent %}
    {% if user.is_authenticated or comment.approved_comment %}

    <!-- ===== Main comment card (top-level comment) ===== -->
    <div class="comment-card"
        style="display: flex; align-items: flex-start; background: #fff; border-radius: 16px; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(207,109,150,0.07); padding: 18px 20px;">

        <!-- Author avatar -->
        <div
            style="width: 48px; height: 48px; border-radius: 50%; background: #f8c3da; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; color: #000000; margin-right: 18px;">
            {{ comment.author|slice:':1'|upper }}
        </div>

        <!-- Right column: meta (author/date/actions) + text + replies -->
        <div style="flex: 1;">

            <!-- Row: author/date + moderation buttons on the right -->
            <div style="display: flex; align-items: center; justify-content: space-between;">

                <!-- Author and timestamp -->
                <div>
                    <span style="font-weight: 500; color: #a55c8f;">From: <span
                            style="font-weight: bold; color: #222;">{{ comment.author }}</span></span><br>
                    <span class="comment-date" style="font-size: 15px; color: #888;">{{ comment.created_date }}</span>
                    <!-- Like/dislike controls -->
                    <div class="comment-like-row"
                        style="margin-top: 6px; display: flex; gap: 16px; align-items: center;">
                        {% if not user.is_authenticated %}
                        <button type="button" class="btn btn-sm btn-outline-success js-like-btn"
                            data-id="{{ comment.pk }}" title="Like" style="border:none;background:none;padding:0;">
                            <span class="comment-reaction">
                                <span class="thumbs-up">{% include 'blog/icons/hand-thumbs-up.svg' %}</span>
                                <span class="reaction-count">{{ comment.likes }}</span>
                            </span>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger js-dislike-btn"
                            data-id="{{ comment.pk }}" title="Dislike" style="border:none;background:none;padding:0;">
                            <span class="comment-reaction">
                                <span class="thumbs-down">{% include 'blog/icons/hand-thumbs-down.svg' %}</span>
                                <span class="reaction-count">{{ comment.dislikes }}</span>
                            </span>
                        </button>
                        {% else %}
                        <span class="comment-reaction">
                            <span class="thumbs-up">{% include 'blog/icons/hand-thumbs-up.svg' %}</span>
                            <span class="reaction-count">{{ comment.likes }}</span>
                        </span>
                        <span class="comment-reaction">
                            <span class="thumbs-down">{% include 'blog/icons/hand-thumbs-down.svg' %}</span>
                            <span class="reaction-count">{{ comment.dislikes }}</span>
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div>

                    <!-- Moderation controls: visible only to authenticated users -->
                    {% if user.is_authenticated %}
                    {% if comment.approved_comment %}

                    <button type="button" class="js-comment-action comment-btn-delete" data-method="POST"
                        data-url="{% url 'comment_remove' pk=comment.pk %}" title="Delete">Delete</button>
                    {% else %}

                    <button type="button" class="js-comment-action comment-btn-approve" data-method="POST"
                        data-url="{% url 'comment_approve' pk=comment.pk %}" title="Approve">Approve</button>
                    <button type="button" class="js-comment-action comment-btn-disapprove" data-method="POST"
                        data-url="{% url 'comment_remove' pk=comment.pk %}" title="Disapprove">Disapprove</button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Comment text -->
            <div class="comment-text" style="margin-top: 10px; font-size: 17px; color: #222;">{{ comment.text }}</div>
            {% if user.is_authenticated and comment.approved_comment %}

            <!-- Reply button and form (only for authenticated users and approved comments) -->
            <div style="margin-top: 8px;">
                <button class="comment-btn-reply" type="button"
                    onclick="this.nextElementSibling.style.display = (this.nextElementSibling.style.display === 'block' ? 'none' : 'block')">Reply</button>
                <form method="POST" action="{% url 'add_reply_to_comment' pk=comment.pk %}" class="reply-form"
                    style="display:none; margin-top:8px; max-width:350px;">
                    {% csrf_token %}
                    <textarea name="text" placeholder="Your reply" class="form-control form-control-sm"
                        style="margin-bottom:6px; min-height:40px; max-width:100%; display:block;" required></textarea>
                    <div style="text-align:left;">
                        <button type="submit" class="comment-btn-reply">Send</button>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- ===== Nested replies ===== -->
            {% for reply in comment.replies.all|dictsort:"created_date" %}
            {% if user.is_authenticated or reply.approved_comment %}
            <div class="reply-card"
                style="margin-left: 48px; margin-top: 12px; background: #f8f3fa !important; border-radius: 12px; padding: 12px 16px; display: flex; align-items: flex-start; justify-content: space-between;">
                <!-- Initial Circle for Admin -->
                <div
                    style="width: 40px; height: 40px; border-radius: 50%; background: #f8c3da; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: #000000; margin-right: 16px; flex-shrink: 0;">
                    {% if reply.author == 'admin' %}A{% else %}{{ reply.author|slice:':1'|upper }}{% endif %}
                </div>

                <!-- Reply content -->
                <div style="flex:1;">
                    <!-- Render reply author and meta info. If author is admin, show special styling. -->
                    {% if reply.author == 'admin' %}
                    <div style="font-size: 15px;">
                        <span style="color: #a55c8f; font-weight: 500;">From:</span>
                        <span style="color: #000; font-weight: bold;"> Admin</span>
                    </div>
                    {% else %}
                    <div style="font-size: 15px; color: #a55c8f; font-weight: 500;">{{ reply.author }}</div>
                    {% endif %}
                    <div style="font-size: 15px; color: #888;">{{ reply.created_date|date:"M d, Y, g:i a" }}</div>
                    <!-- Like/dislike controls for replies. -->
                    <div class="comment-like-row"
                        style="margin-top: 6px; display: flex; gap: 16px; align-items: center;">
                        <!-- Unauthenticated users see buttons for like/dislike. Authenticated users see static icons and numbers. -->
                        {% if not user.is_authenticated %}
                        <button type="button" class="btn btn-sm btn-outline-success js-like-btn"
                            data-id="{{ reply.pk }}" title="Like" style="border:none;background:none;padding:0;">
                            <span class="comment-reaction">
                                <span class="thumbs-up">{% include 'blog/icons/hand-thumbs-up.svg' %}</span>
                                <span class="reaction-count">{{ reply.likes }}</span>
                            </span>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger js-dislike-btn"
                            data-id="{{ reply.pk }}" title="Dislike" style="border:none;background:none;padding:0;">
                            <span class="comment-reaction">
                                <span class="thumbs-down">{% include 'blog/icons/hand-thumbs-down.svg' %}</span>
                                <span class="reaction-count">{{ reply.dislikes }}</span>
                            </span>
                        </button>
                        {% else %}
                        <!-- Authenticated users see static like/dislike counts for replies. -->
                        <span style="display:inline-flex;align-items:center;gap:16px;">
                            <span class="comment-reaction">
                                <span class="thumbs-up">{% include 'blog/icons/hand-thumbs-up.svg' %}</span>
                                <span class="reaction-count">{{ reply.likes }}</span>
                            </span>
                            <span class="comment-reaction">
                                <span class="thumbs-down">{% include 'blog/icons/hand-thumbs-down.svg' %}</span>
                                <span class="reaction-count">{{ reply.dislikes }}</span>
                            </span>
                        </span>
                        {% endif %}
                    </div>
                    <!-- Reply text content -->
                    <div style="margin-top: 4px; color: #030303; font-size: 16px;">{{ reply.text }}</div>
                </div>

                <!-- Delete reply (admins only) -->
                {% if user.is_authenticated %}
                <div style="margin-left: 12px; display: flex; align-items: flex-start;">
                    <button type="button" class="js-comment-action comment-btn-delete" data-method="POST"
                        data-url="{% url 'comment_remove' pk=reply.pk %}" title="Delete">Delete</button>
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}
    {% empty %}
    <p>No comments yet.</p>
    {% endfor %}
</div>
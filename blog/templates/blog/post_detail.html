<!-- Displays a single blog post in detail, with:
       - Full post content
       - Action buttons (publish/edit/delete)
       - Comment form (normal + modal)
       - Dynamic AJAX comment loading
     --------------------------------------------------------- -->

{% extends 'blog/base.html' %}

{% block content %}
<!-- Popup for comment approval notification -->
{% if messages %}
<div id="comment-approval-popup" class="alert alert-success text-center"
    style="position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px; max-width: 90vw;">
    {% for message in messages %}
    {{ message }}
    {% endfor %}
</div>
<script>
    setTimeout(function () {
        var popup = document.getElementById('comment-approval-popup');
        if (popup) popup.style.display = 'none';
    }, 4000);
</script>
{% endif %}
<!-- Banner section for post detail -->
<section class="hero-section text-white py-5 full-width-banner post-detail"
    style="background: linear-gradient(rgba(25,43,55,0.6), rgba(25,43,55,0.6)), url('/static/blog/img/photo-post_detail.jpg') center/cover no-repeat; border-radius: 0; width: 100vw; position: relative; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; min-height: 190px;">
</section>
<div class="post-article-container" style="overflow-x:hidden;">
    <div class="w-100 px-5">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h1 class="text-start" style="margin-bottom: 0;">{{ post.title }}</h1>
            <div class="actions-row" style="display: flex; gap: 8px;">
                {% if user.is_authenticated %}
                {% if not post.published_date %}
                <form method="post" action="{% url 'post_publish' pk=post.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-secondary" title="Publish">
                        {% include './icons/file-earmark-plus.svg' %} Publish
                    </button>
                </form>
                {% endif %}
                <a class="btn btn-secondary" href="{% url 'post_edit' pk=post.pk %}" title="Edit">
                    {% include './icons/pencil-fill.svg' %}
                </a>
                <form method="post" action="{% url 'post_remove' pk=post.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-secondary" title="Delete">
                        {% include './icons/trash-fill.svg' %}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        <div class="post-text text-start">{{ post.text|safe }}</div>
    </div>
</div>

<!-- Add spacing between post details and comments section -->
<div style="height: 32px;"></div>

{% if post.published_date %}
<div id="comments-part">
    <div id="comments-list">
        {% include 'blog/comments_list.html' %}
    </div>
</div>
{% endif %}

<!-- ===================== COMMENT MODAL ===================== -->
<div class="modal fade" id="addCommentModal" tabindex="-1" aria-labelledby="addCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- unique id + shared class -->
            <form id="comment-form-modal" class="js-comment-form" method="POST"
                action="{% url 'add_comment_to_post' pk=post.pk %}">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCommentModalLabel">New comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <h5 class="modal-title" id="addCommentModalLabel">New comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="addCommentModalLabel">New comment</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}
                            {% csrf_token %}
                            <button type="submit" class="btn btn-secondary">Send</button>
                        </div>
            </form>
        </div>
    </div>
</div>


<!-- ===================== AJAX HANDLERS ===================== -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const listEl = document.getElementById('comments-list');
        const sectionEl = document.getElementById('comments-part');
        // Inject authentication status from Django
        const isAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}" === "true";
        // Keep viewport anchored on comments after each update
        function stayInComments() {
            if (sectionEl) sectionEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ADD COMMENT (works for inline + modal via shared class)
        document.querySelectorAll('.js-comment-form').forEach((form) => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const res = await fetch(form.action, {
                    method: form.method,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: new FormData(form)
                });
                if (res.ok) {
                    listEl.innerHTML = await res.text();
                    form.reset();
                    const modalEl = document.getElementById('addCommentModal');
                    if (modalEl && window.bootstrap) {
                        const modal = window.bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();
                    }
                    if (isAuthenticated) stayInComments();
                }
            });
        });

        // REPLY TO COMMENT (AJAX, stays in place, works for all reply forms)
        document.addEventListener('submit', async (e) => {
            const form = e.target.closest('.reply-form');
            if (!form) return;
            e.preventDefault();
            const res = await fetch(form.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') },
                body: new FormData(form)
            });
            if (res.ok) {
                listEl.innerHTML = await res.text();
                // Reset all reply forms after update
                document.querySelectorAll('.reply-form').forEach(f => f.reset && f.reset());
                if (isAuthenticated) stayInComments();
            }
        });

        // ------------------- APPROVE / DELETTE ---------------
        document.addEventListener('click', async (e) => {
            const actionEl = e.target.closest('.js-comment-action');
            if (!actionEl) return;

            e.preventDefault();

            const url = actionEl.dataset.url;
            const method = (actionEl.dataset.method || 'GET').toUpperCase();

            const headers = { 'X-Requested-With': 'XMLHttpRequest' };
            let body = null;

            if (method === 'POST') {
                headers['X-CSRFToken'] = getCookie('csrftoken');
                body = new FormData();
            }

            const res = await fetch(url, { method, headers, body });
            if (res.ok) {
                listEl.innerHTML = await res.text();
                if (isAuthenticated) stayInComments();
            }
        });

        //------------------- CSFR helper -------------------
        function getCookie(name) {
            let c = document.cookie ? document.cookie.split(';') : [];
            for (let i = 0; i < c.length; i++) {
                let x = c[i].trim();
                if (x.substring(0, name.length + 1) === (name + '=')) {
                    return decodeURIComponent(x.substring(name.length + 1));
                }
            }
            return null;
        }
    });
</script>
{% endblock %}